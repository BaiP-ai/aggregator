name: Deploy AI Aggregator to GitHub Pages
# This workflow is specifically for the BaiP-ai/aggregator repository

on:
  # Trigger the workflow every time you push to the `main` branch
  push:
    branches: [ main ]
  # Run daily at midnight UTC to keep data fresh
  schedule:
    - cron: '0 0 * * *'
  # Allows you to run this workflow manually from the Actions tab on GitHub.
  workflow_dispatch:

# Allow this job to clone the repo and create a page deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    # Only run on the BaiP-ai/aggregator repository
    if: github.repository == 'BaiP-ai/aggregator'
    steps:
      - name: Verify repository
        run: |
          echo "Running on repository: ${{ github.repository }}"
          echo "Expected repository: BaiP-ai/aggregator"
          if [ "${{ github.repository }}" != "BaiP-ai/aggregator" ]; then
            echo "ERROR: This workflow should only run on BaiP-ai/aggregator"
            exit 1
          fi

      # Use Astro action with our enhanced build script that includes data processing
      - name: Build and upload site with complete data processing
        uses: withastro/action@v3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BASE_URL: /aggregator
          SITE: https://www.baip.ai
        with:
          path: . # The root location of your Astro project inside the repository
          node-version: 18 # The specific version of Node that should be used to build your site
          package-manager: npm # The Node package manager that should be used to install dependencies
          # The build-with-logos script will handle: fetch-data → ensure-logo-fields → process-data → validate-data → astro build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    # Only run on the BaiP-ai/aggregator repository
    if: github.repository == 'BaiP-ai/aggregator'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4